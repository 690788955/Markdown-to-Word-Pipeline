# 应急预案

## 应急响应流程

```
发现问题 → 初步判断 → 启动预案 → 处置恢复 → 复盘总结
    │           │           │           │           │
    ▼           ▼           ▼           ▼           ▼
  监控告警    确定级别    通知相关人   执行恢复    编写报告
  用户反馈    影响范围    启动会议    验证结果    改进措施
```

## 应急联系人

| 角色 | 姓名 | 电话 | 职责 |
|------|------|------|------|
| 应急总指挥 | 张总 | 138xxxx0001 | 决策、资源协调 |
| 技术负责人 | 李工 | 138xxxx0002 | 技术方案、指挥处置 |
| 运维值班 | 王工 | 138xxxx0003 | 一线处置 |
| DBA | 赵工 | 138xxxx0004 | 数据库相关 |
| 网络管理员 | 钱工 | 138xxxx0005 | 网络相关 |

## 常见应急场景

### 场景一：服务器宕机

**影响**：业务中断

**处置步骤**：

1. 确认服务器状态
```bash
ping 10.0.1.11
ssh root@10.0.1.11
```

2. 尝试远程重启
```bash
# 通过IPMI/iLO重启
ipmitool -I lanplus -H 10.0.10.11 -U admin -P xxx power cycle
```

3. 如无法恢复，切换到备用服务器
```bash
# 修改负载均衡配置，摘除故障节点
vim /etc/nginx/upstream.conf
nginx -s reload
```

4. 联系机房现场处理

### 场景二：数据库主从切换

**影响**：短暂写入中断

**处置步骤**：

1. 确认主库状态
```bash
mysql -h 10.0.3.11 -e "SELECT 1"
```

2. 检查从库同步状态
```sql
SHOW SLAVE STATUS\G
```

3. 执行主从切换
```bash
# 停止从库复制
STOP SLAVE;

# 提升从库为主库
RESET SLAVE ALL;

# 修改应用配置指向新主库
```

4. 通知开发团队确认

### 场景三：磁盘空间不足

**影响**：服务异常、数据写入失败

**处置步骤**：

1. 查看磁盘使用
```bash
df -h
du -sh /* | sort -rh | head -20
```

2. 清理日志文件
```bash
# 清理7天前的日志
find /var/log -name "*.log" -mtime +7 -delete

# 清理Docker无用镜像
docker system prune -af
```

3. 如仍不足，扩容磁盘

### 场景四：DDoS攻击

**影响**：服务不可用

**处置步骤**：

1. 确认攻击类型
```bash
# 查看连接数
netstat -an | grep ESTABLISHED | wc -l

# 查看访问IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -20
```

2. 启用云防护
- 联系云服务商开启DDoS防护
- 启用WAF规则

3. 临时封禁攻击IP
```bash
iptables -A INPUT -s 攻击IP -j DROP
```

4. 联系安全团队分析

## 应急物资清单

| 物资 | 数量 | 存放位置 |
|------|------|---------|
| 备用服务器 | 2台 | 机房 |
| 备用硬盘 | 4块 | 机房 |
| 网线 | 10根 | 机房 |
| 笔记本电脑 | 2台 | 办公室 |
| 4G上网卡 | 2张 | 办公室 |

## 应急演练计划

| 演练项目 | 频率 | 参与人员 |
|---------|------|---------|
| 服务器故障切换 | 每季度 | 运维团队 |
| 数据库主从切换 | 每季度 | DBA |
| 数据恢复演练 | 每半年 | 运维+DBA |
| 全站灾备切换 | 每年 | 全体 |
