<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库编辑器 - 运维文档生成系统</title>
    <link rel="stylesheet" href="/static/style.css?v=12">
    <link rel="stylesheet" href="/static/editor.css?v=4">
    <!-- Vditor Markdown 编辑器 -->
    <link rel="stylesheet" href="/static/vendor/vditor/dist/index.css" />
    <script src="/static/vendor/vditor/dist/index.min.js"></script>
    <!-- Viewer.js 图片查看器 -->
    <link rel="stylesheet" href="/static/vendor/viewerjs/dist/viewer.min.css">
    <script src="/static/vendor/viewerjs/dist/viewer.min.js"></script>
    <!-- highlight.js 代码高亮主题 -->
    <link id="hljsTheme" rel="stylesheet" href="/static/vendor/vditor/dist/js/highlight.js/styles/github.min.css">
</head>

<body class="editor-page">
    <div class="editor-container">
        <!-- 顶部导航栏 -->
        <header class="editor-header">
            <div class="header-left">
                <a href="/" class="back-btn" title="返回主页">
                    <span class="back-icon">←</span>
                    <span class="back-text">返回</span>
                </a>
                <h1 class="editor-title">知识库编辑器</h1>
            </div>
            
            <div class="header-right">
                <!-- VSCode 风格的活动栏按钮 -->
                <div class="activity-bar">
                    <button id="toggleFileTree" class="activity-btn is-active" title="资源管理器 (Ctrl+Shift+E)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 7V17C3 18.1046 3.89543 19 5 19H19C20.1046 19 21 18.1046 21 17V9C21 7.89543 20.1046 7 19 7H13L11 5H5C3.89543 5 3 5.89543 3 7Z"/>
                        </svg>
                    </button>
                    <button id="toggleGitPanel" class="activity-btn" title="源代码管理 (Ctrl+Shift+G)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="6" cy="6" r="2"/>
                            <circle cx="18" cy="18" r="2"/>
                            <circle cx="6" cy="18" r="2"/>
                            <path d="M6 8V16"/>
                            <path d="M6 8C6 8 6 12 12 12C18 12 18 16 18 16"/>
                        </svg>
                        <span id="gitBadge" class="activity-badge" style="display:none;">0</span>
                    </button>
                </div>
                <div class="header-group header-group-theme">
                    <button id="themeToggleBtn" class="header-btn header-btn-theme" title="主题设置">
                        <span class="theme-dot"></span>
                        <span class="theme-text">主题</span>
                    </button>
                    <div id="themePanel" class="theme-panel">
                        <div class="theme-panel-title">主题设置</div>
                        
                        <!-- 主题预设 -->
                        <div class="theme-row">
                            <span class="theme-label">主题预设</span>
                        </div>
                        <div class="theme-row theme-presets" id="themePresets">
                            <!-- 预设按钮将由 JS 动态生成 -->
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 基础主题 -->
                        <div class="theme-row">
                            <button class="theme-chip" data-theme-option="light">浅色</button>
                            <button class="theme-chip" data-theme-option="dark">深色</button>
                        </div>
                        <div class="theme-row">
                            <label class="theme-label" for="themeAccentInput">强调色</label>
                            <input id="themeAccentInput" type="color" value="#1a8fbf">
                        </div>
                        <div class="theme-row theme-swatches">
                            <button class="theme-swatch" data-accent="#1a8fbf" style="--swatch: #1a8fbf;"></button>
                            <button class="theme-swatch" data-accent="#1f7ae0" style="--swatch: #1f7ae0;"></button>
                            <button class="theme-swatch" data-accent="#14b8a6" style="--swatch: #14b8a6;"></button>
                            <button class="theme-swatch" data-accent="#2f855a" style="--swatch: #2f855a;"></button>
                            <button class="theme-swatch" data-accent="#0ea5e9" style="--swatch: #0ea5e9;"></button>
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 内容设置 -->
                        <div class="theme-row">
                            <span class="theme-label">内容密度</span>
                            <button class="theme-chip" data-content-style="comfortable">舒适</button>
                            <button class="theme-chip" data-content-style="compact">紧凑</button>
                        </div>
                        <div class="theme-row">
                            <span class="theme-label">内容宽度</span>
                            <button class="theme-chip" data-content-width="narrow">窄</button>
                            <button class="theme-chip" data-content-width="medium">中</button>
                            <button class="theme-chip" data-content-width="wide">宽</button>
                            <button class="theme-chip" data-content-width="full">全宽</button>
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 字体设置 -->
                        <div class="theme-row">
                            <span class="theme-label">字体</span>
                            <select id="fontFamilySelect" class="theme-select">
                                <option value="system-ui, -apple-system, sans-serif">系统默认</option>
                                <option value="Georgia, serif">衬线字体</option>
                                <option value="Consolas, monospace">等宽字体</option>
                            </select>
                        </div>
                        <div class="theme-row">
                            <span class="theme-label">字号</span>
                            <input type="range" id="fontSizeSlider" min="12" max="24" value="16" class="theme-slider">
                            <span id="fontSizeValue" class="theme-value">16px</span>
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 代码配色 -->
                        <div class="theme-row">
                            <span class="theme-label">代码配色</span>
                        </div>
                        <div class="theme-row theme-code-themes">
                            <button class="theme-code-chip" data-code-theme="github" title="经典 GitHub 风格">
                                <span class="theme-code-preview">
                                    <span style="background:#24292e"></span>
                                    <span style="background:#d73a49"></span>
                                    <span style="background:#6f42c1"></span>
                                    <span style="background:#22863a"></span>
                                </span>
                                <span class="theme-code-name">GitHub</span>
                            </button>
                            <button class="theme-code-chip" data-code-theme="atom-one" title="Atom One Dark 配色">
                                <span class="theme-code-preview">
                                    <span style="background:#282c34"></span>
                                    <span style="background:#e06c75"></span>
                                    <span style="background:#c678dd"></span>
                                    <span style="background:#98c379"></span>
                                </span>
                                <span class="theme-code-name">One Dark</span>
                            </button>
                            <button class="theme-code-chip" data-code-theme="vs" title="Visual Studio Code 风格">
                                <span class="theme-code-preview">
                                    <span style="background:#1e1e1e"></span>
                                    <span style="background:#569cd6"></span>
                                    <span style="background:#ce9178"></span>
                                    <span style="background:#4ec9b0"></span>
                                </span>
                                <span class="theme-code-name">VS Code</span>
                            </button>
                            <button class="theme-code-chip" data-code-theme="monokai" title="经典 Monokai 配色">
                                <span class="theme-code-preview">
                                    <span style="background:#272822"></span>
                                    <span style="background:#f92672"></span>
                                    <span style="background:#ae81ff"></span>
                                    <span style="background:#a6e22e"></span>
                                </span>
                                <span class="theme-code-name">Monokai</span>
                            </button>
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 默认编辑模式 -->
                        <div class="theme-row">
                            <span class="theme-label">编辑模式</span>
                            <select id="defaultEditorMode" class="theme-select">
                                <option value="ir">IR 模式</option>
                                <option value="wysiwyg">所见即所得</option>
                                <option value="sv">分屏预览</option>
                            </select>
                        </div>
                        
                        <div class="theme-divider"></div>
                        
                        <!-- 导入导出 -->
                        <div class="theme-row theme-actions">
                            <button id="exportThemeBtn" class="theme-action-btn" title="导出当前主题配置">导出</button>
                            <button id="importThemeBtn" class="theme-action-btn" title="导入主题配置">导入</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="editor-main">
            <!-- 左侧：文件树面板 -->
            <aside id="fileTreePanel" class="file-tree-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M3 7V17C3 18.1 3.9 19 5 19H19C20.1 19 21 18.1 21 17V9C21 7.9 20.1 7 19 7H13L11 5H5C3.9 5 3 5.9 3 7Z"/>
                        </svg>
                        文档
                    </span>
                    <div class="panel-actions">
                        <button id="newFileBtn" class="panel-btn" title="新建文件">+</button>
                        <button id="refreshTreeBtn" class="panel-btn" title="刷新">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="fileSearch" placeholder="搜索文件..." />
                </div>
                <div id="fileTree" class="file-tree">
                    <div class="tree-loading">加载中...</div>
                </div>
            </aside>

            <!-- 左侧拖拽分隔条 -->
            <div id="leftResizer" class="resizer resizer-left"></div>

            <!-- 中间：编辑区域 -->
            <section class="editor-section">
                <!-- 面包屑导航 -->
                <div id="breadcrumbNav" class="breadcrumb-nav" style="display: none;"></div>
                <!-- 标签栏 -->
                <div id="tabBar" class="tab-bar">
                    <div id="tabList" class="tab-list">
                        <div class="tab-empty">打开文件开始编辑</div>
                    </div>
                </div>
                <!-- 编辑器容器 -->
                <div id="editorContainer" class="editor-content">
                    <div class="editor-placeholder">
                        <svg class="placeholder-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <div class="placeholder-text">从左侧选择文件开始编辑</div>
                    </div>
                </div>
                <!-- 附件面板 -->
                <div id="attachmentPanel" class="attachment-panel" style="display: none;">
                    <div class="attachment-header">
                        <button id="attachmentToggle" class="attachment-toggle" title="展开/折叠附件">
                            <span class="attachment-toggle-icon">▼</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                            </svg>
                            <span class="attachment-title">附件</span>
                            <span id="attachmentCount" class="attachment-count">0</span>
                        </button>
                        <button id="attachmentRefresh" class="panel-btn attachment-refresh" title="刷新">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                        </button>
                    </div>
                    <div id="attachmentContent" class="attachment-content">
                        <div class="attachment-scroll-indicator attachment-scroll-left" style="display: none;">‹</div>
                        <div id="attachmentStrip" class="attachment-strip">
                            <!-- 附件缩略图卡片将在这里渲染 -->
                        </div>
                        <div class="attachment-scroll-indicator attachment-scroll-right" style="display: none;">›</div>
                        <div id="attachmentEmpty" class="attachment-empty" style="display: none;">
                            <svg class="attachment-empty-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                <path d="M3 7V17C3 18.1 3.9 19 5 19H19C20.1 19 21 18.1 21 17V9C21 7.9 20.1 7 19 7H13L11 5H5C3.9 5 3 5.9 3 7Z"/>
                            </svg>
                            <span class="attachment-empty-text">暂无附件</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 右侧拖拽分隔条 -->
            <div id="rightResizer" class="resizer resizer-right"></div>

            <!-- 右侧：Git 面板 -->
            <aside id="gitPanel" class="git-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="6" cy="6" r="2"/>
                            <circle cx="18" cy="18" r="2"/>
                            <circle cx="6" cy="18" r="2"/>
                            <path d="M6 8V16"/>
                            <path d="M6 8C6 8 6 12 12 12C18 12 18 16 18 16"/>
                        </svg>
                        版本控制
                    </span>
                    <button id="gitRefreshBtn" class="panel-btn" title="刷新">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                        </svg>
                    </button>
                </div>
                <div id="gitContent" class="git-content">
                    <div class="git-loading">加载中...</div>
                </div>
            </aside>
        </main>
    </div>

    <!-- 右键上下文菜单 -->
    <div id="contextMenu" class="context-menu" style="display:none;">
        <div class="context-item" data-action="new">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            新建文件
        </div>
        <div class="context-item" data-action="newFolder">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                <line x1="12" y1="11" x2="12" y2="17"/>
                <line x1="9" y1="14" x2="15" y2="14"/>
            </svg>
            新建文件夹
        </div>
        <div class="context-divider"></div>
        <div class="context-item" data-action="rename">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            重命名
        </div>
        <div class="context-item" data-action="delete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            删除
        </div>
        <div class="context-divider"></div>
        <div class="context-item" data-action="history">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            查看历史
        </div>
    </div>

    <!-- 附件右键菜单 -->
    <div id="attachmentContextMenu" class="context-menu" style="display:none;">
        <div class="context-item" data-action="copyRef">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            复制引用
        </div>
        <div class="context-item" data-action="preview">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            预览
        </div>
        <div class="context-divider"></div>
        <div class="context-item" data-action="renameAttachment">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            重命名
        </div>
        <div class="context-item context-item-danger" data-action="deleteAttachment">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            删除
        </div>
    </div>

    <!-- 模态框：新建文件 -->
    <div id="newFileModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>新建文件</h3>
                <button class="modal-close" onclick="hideNewFileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newFilePath">文件路径</label>
                    <input type="text" id="newFilePath" placeholder="例如：01-运维/新文档.md">
                    <small class="form-hint">相对于 src/ 目录，必须以 .md 结尾</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideNewFileModal()">取消</button>
                <button class="btn btn-primary" onclick="createNewFile()">创建</button>
            </div>
        </div>
    </div>

    <!-- 模态框：重命名 -->
    <div id="renameModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>重命名</h3>
                <button class="modal-close" onclick="hideRenameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newFileName">新文件名</label>
                    <input type="text" id="newFileName" placeholder="新文件名.md">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideRenameModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmRename()">确认</button>
            </div>
        </div>
    </div>

    <!-- 模态框：确认删除 -->
    <div id="deleteModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>确认删除</h3>
                <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">确定要删除此文件吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideDeleteModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
            </div>
        </div>
    </div>

    <!-- 模态框：未保存提示 -->
    <div id="unsavedModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>未保存的更改</h3>
                <button class="modal-close" onclick="hideUnsavedModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>当前文件有未保存的更改，是否保存？</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="discardChanges()">不保存</button>
                <button class="btn btn-primary" onclick="saveAndClose()">保存</button>
                <button class="btn btn-outline" onclick="hideUnsavedModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- JavaScript 模块（按依赖顺序加载，使用 defer 避免阻塞渲染） -->
    <script src="/static/editor/utils.js?v=3" defer></script>
    <script src="/static/editor/state.js?v=3" defer></script>
    <script src="/static/editor/loading.js?v=1" defer></script>
    <script src="/static/editor/recent.js?v=1" defer></script>
    <script src="/static/editor/theme.js?v=3" defer></script>
    <script src="/static/editor/layout.js?v=2" defer></script>
    <script src="/static/editor/tree.js?v=3" defer></script>
    <script src="/static/editor/virtual-tree.js?v=1" defer></script>
    <script src="/static/editor/tabs.js?v=2" defer></script>
    <script src="/static/editor/vditor.js?v=2" defer></script>
    <script src="/static/editor/editor-cache.js?v=1" defer></script>
    <script src="/static/editor/git.js?v=2" defer></script>
    <script src="/static/editor/files.js?v=2" defer></script>
    <script src="/static/editor/attachments.js?v=2" defer></script>
    <script src="/static/editor/quickopen.js?v=1" defer></script>
    <script src="/static/editor/commands.js?v=1" defer></script>
    <script src="/static/editor/autosave.js?v=1" defer></script>
    <script src="/static/editor/breadcrumb.js?v=1" defer></script>
    <script src="/static/editor/history.js?v=1" defer></script>
    <script src="/static/editor/main.js?v=5" defer></script>
</body>

</html>
