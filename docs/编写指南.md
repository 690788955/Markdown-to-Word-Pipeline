# 运维文档编写指南

本指南介绍如何编写文档模块和配置客户文档。

## 目录结构

```
project-root/
├── src/                      # 文档模块目录
│   ├── metadata.yaml         # 默认元数据
│   ├── 01-概述.md            # 模块文件（按编号排序）
│   ├── 02-系统架构.md
│   ├── 01-运维/              # 子目录（可选）
│   │   ├── 01-日常巡检.md
│   │   └── 02-变更管理.md
│   └── images/               # 图片资源
│       └── architecture.png
│
├── clients/                  # 客户配置目录
│   ├── 标准文档/             # 客户目录
│   │   ├── metadata.yaml     # 客户元数据
│   │   ├── 运维手册.yaml     # 文档类型配置
│   │   └── 部署手册.yaml
│   └── 其他客户/
│
└── templates/                # Word 模板
    └── default.docx
```

---

## 一、编写文档模块

### 1.1 文件命名规范

```
XX-模块名称.md
```

- `XX` 为两位数字编号，用于排序（01, 02, 03...）
- 模块名称使用中文，简洁明了
- 子目录同样使用编号前缀

**示例：**
```
src/
├── 01-概述.md
├── 02-系统架构.md
├── 03-日常运维.md
├── 01-运维/
│   ├── 01-日常巡检.md
│   └── 02-变更管理.md
```

### 1.2 基本模块结构

```markdown
# 模块标题

模块简介内容...

## 二级标题

正文内容...

### 三级标题

详细内容...
```

### 1.3 完整模块示例

```markdown
# 系统架构

本章节描述系统的整体架构设计。

## 架构概览

系统采用微服务架构，主要包含以下组件：

- **API 网关**: 统一入口，负责路由和鉴权
- **业务服务**: 核心业务逻辑处理
- **数据库**: MySQL 主从集群

## 服务器清单

| 序号 | 主机名 | IP 地址 | 用途 |
|------|--------|---------|------|
| 1 | app-01 | 192.168.1.10 | 应用服务器 |
| 2 | db-01 | 192.168.1.20 | 数据库主节点 |
| 3 | db-02 | 192.168.1.21 | 数据库从节点 |

## 架构图

![系统架构图](images/architecture.png)

## 技术栈

- 后端：Java 17 + Spring Boot 3.x
- 数据库：MySQL 8.0
- 缓存：Redis 7.x
- 消息队列：RabbitMQ
```

### 1.4 图片引用

图片放在 `src/images/` 目录下，使用相对路径引用：

```markdown
![图片描述](images/文件名.png)
```

### 1.5 表格语法

```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 数据1 | 数据2 | 数据3 |
| 数据4 | 数据5 | 数据6 |
```

### 1.6 代码块

```markdown
​```bash
# Shell 命令示例
systemctl restart nginx
​```

​```sql
-- SQL 示例
SELECT * FROM users WHERE status = 1;
​```
```

---

## 二、变量模板功能

变量模板允许在文档中定义可替换的占位符，生成时动态填入实际值。

### 2.1 变量声明

在 Markdown 文件头部使用 YAML front-matter 声明变量：

```markdown
---
title: 文档标题
variables:
  project_name:
    description: 项目名称
    type: text
    default: XX系统
  
  version:
    description: 版本号
    type: text
    default: v1.0.0
  
  deploy_date:
    description: 部署日期
    type: date
    default: "2026-01-01"
  
  server_count:
    description: 服务器数量
    type: number
    min: 1
    max: 100
    default: 3
  
  environment:
    description: 部署环境
    type: select
    options:
      - 开发环境
      - 测试环境
      - 生产环境
    default: 生产环境
---

# 正文开始...
```

### 2.2 变量类型

| 类型 | 说明 | 特殊属性 |
|------|------|----------|
| `text` | 文本 | `pattern`: 正则验证 |
| `number` | 数字 | `min`, `max`: 范围限制 |
| `date` | 日期 | 格式: YYYY-MM-DD |
| `select` | 下拉选择 | `options`: 选项列表 |

### 2.3 使用变量

在文档正文中使用双大括号引用变量：

```markdown
## 项目信息

- **项目名称**: {{project_name}}
- **版本号**: {{version}}
- **部署日期**: {{deploy_date}}
- **部署环境**: {{environment}}

本项目部署在 {{server_count}} 台服务器上。
```

### 2.4 转义语法

如需显示字面的双大括号，使用反斜杠转义：

```markdown
输入: \{{不替换}}
输出: {{不替换}}
```

---

## 三、配置客户文档

### 3.1 创建客户目录

```bash
# 复制标准模板
cp -r clients/标准文档 clients/新客户名称
```

### 3.2 客户元数据 (metadata.yaml)

```yaml
# clients/新客户/metadata.yaml
title: XX银行运维手册
author: 运维团队
version: v1.0.0
date: 2026-01-08
```

### 3.3 文档类型配置

每个 `.yaml` 文件（除 metadata.yaml）代表一种文档类型：

```yaml
# clients/新客户/运维手册.yaml

# 客户显示名称
client_name: XX银行

# Word 模板（在 templates/ 目录下）
template: default.docx

# 包含的模块列表（按顺序）
modules:
  - src/01-概述.md
  - src/02-系统架构.md
  - src/03-日常运维.md
  - src/04-故障处理.md
  - src/05-监控告警.md

# Pandoc 参数
pandoc_args:
  - --toc                # 生成目录
  - --number-sections    # 章节编号
  - --standalone

# 输出文件名模式
# 可用占位符: {client}, {title}, {version}, {date}
output_pattern: '{client}_运维手册_{date}.docx'

# 变量值（覆盖模块中的默认值）
variables:
  project_name: XX银行核心系统
  version: v2.0.0
  environment: 生产环境
  server_count: 10
```

### 3.4 使用通配符

```yaml
modules:
  - src/01-运维/*.md    # 包含子目录下所有 .md 文件
  - src/02-*.md         # 包含所有 02- 开头的文件
```

### 3.5 PDF 输出配置

```yaml
# PDF 专用选项
pdf_options:
  # 封面设置
  titlepage: true
  titlepage-color: "2C3E50"
  titlepage-text-color: "FFFFFF"
  
  # 字体设置（需要系统安装对应字体）
  mainfont: "Microsoft YaHei"
  monofont: "Consolas"
  
  # 目录设置
  toc-own-page: true
  
  # 链接颜色
  colorlinks: true
  linkcolor: "2980b9"
```

---

## 四、完整配置示例

### 4.1 简单配置

```yaml
# clients/示例客户/快速文档.yaml
client_name: 示例客户
template: default.docx
modules:
  - src/01-概述.md
  - src/02-系统架构.md
output_pattern: '{client}_文档_{date}.docx'
```

### 4.2 完整配置

```yaml
# clients/XX银行/运维手册.yaml
client_name: XX银行

template: default.docx

modules:
  - src/01-概述.md
  - src/02-系统架构.md
  - src/03-日常运维.md
  - src/04-故障处理.md
  - src/05-监控告警.md
  - src/06-备份恢复.md
  - src/07-安全规范.md
  - src/08-部署上线.md
  - src/09-应急预案.md
  - src/10-项目背景.md
  - src/11-联系人.md

pandoc_args:
  - --toc
  - --toc-depth=3
  - --number-sections
  - --standalone
  - --shift-heading-level-by=-1

output_pattern: '{client}_{title}_{version}_{date}.docx'

variables:
  project_name: XX银行核心业务系统
  version: v3.0.0
  deploy_date: "2026-01-08"
  environment: 生产环境
  server_count: 20
  contact_email: ops@xxbank.com

pdf_options:
  titlepage: true
  titlepage-color: "1a365d"
  titlepage-text-color: "ffffff"
  mainfont: "Noto Sans CJK SC"
  monofont: "Noto Sans Mono"
  toc-own-page: true
  colorlinks: true
```

---

## 五、构建文档

### 5.1 命令行构建

**Windows (PowerShell):**
```powershell
# 构建指定文档
.\build.ps1 -Client XX银行 -Doc 运维手册

# 生成 PDF
.\build.ps1 -Client XX银行 -Doc 运维手册 -Format pdf

# 构建所有文档
.\build.ps1 -Client XX银行 -BuildAll

# 列出可用文档类型
.\build.ps1 -Client XX银行 -ListDocs
```

**Linux/macOS:**
```bash
make client=XX银行 doc=运维手册
make client=XX银行 doc=运维手册 format=pdf
```

### 5.2 Web 界面构建

1. 启动 Web 服务: `./web/doc-generator-web.exe`
2. 访问 http://localhost:8080
3. 选择客户和文档类型
4. 填写变量值（如有）
5. 点击"生成文档"

---

## 六、最佳实践

### 6.1 模块设计原则

- **单一职责**: 每个模块只描述一个主题
- **独立完整**: 模块可独立阅读，不依赖其他模块上下文
- **适度粒度**: 不要太大（难以复用）或太小（管理困难）

### 6.2 命名建议

- 使用有意义的中文名称
- 编号留有间隔（01, 05, 10...），便于后续插入
- 子目录用于组织相关模块

### 6.3 变量使用建议

- 只对需要定制的内容使用变量
- 提供合理的默认值
- 添加清晰的描述信息

### 6.4 版本管理

- 使用 Git 管理文档源文件
- 生成的文档（build/）不纳入版本控制
- 重要版本打 Tag 标记

---

## 七、常见问题

### Q: 图片不显示？
A: 确保图片路径正确，使用 `images/文件名.png` 格式。

### Q: 中文乱码？
A: 确保文件保存为 UTF-8 编码。

### Q: 变量没有替换？
A: 检查变量名是否一致，确保在 front-matter 中声明了变量。

### Q: PDF 生成失败？
A: 运行 `.\build.ps1 -CheckPdfDeps` 检查依赖是否安装。
