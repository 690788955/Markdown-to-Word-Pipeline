# ==========================================
# 运维文档生成系统 - GitLab CI/CD
# 支持 Word 和 PDF 格式输出
# ==========================================

stages:
  - build

variables:
  # 默认客户配置，可通过 CI/CD 变量覆盖
  CLIENT: "default"
  # 输出格式：word 或 pdf
  FORMAT: "word"

# ==========================================
# PDF 依赖安装脚本
# ==========================================
.install_pdf_deps: &install_pdf_deps
  - mkdir -p ~/.local/share/pandoc/templates
  - wget -q -O ~/.local/share/pandoc/templates/eisvogel.latex
    https://raw.githubusercontent.com/Wandmalfarbe/pandoc-latex-template/master/eisvogel.latex
  - apk add --no-cache font-noto-cjk || true
  - fc-cache -fv || true

# ==========================================
# 脚本权限设置
# ==========================================
.set_script_permissions: &set_script_permissions
  - chmod +x bin/*.sh 2>/dev/null || true
  - echo "[CI] bin 目录脚本权限已设置"

# ==========================================
# Word 文档构建
# ==========================================

# 构建 Word 文档
build-document:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - *set_script_permissions
    - mkdir -p build templates
  
  script:
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    - make client=${CLIENT} format=word
  
  artifacts:
    name: "document-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
    expire_in: 1 week
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
    - when: manual
      allow_failure: true

# ==========================================
# PDF 文档构建
# ==========================================

# 构建 PDF 文档
build-pdf:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - *set_script_permissions
    - mkdir -p build templates
    # 安装 PDF 依赖
    - *install_pdf_deps
  
  script:
    - make client=${CLIENT} format=pdf
  
  artifacts:
    name: "pdf-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.pdf
    expire_in: 1 week
  
  rules:
    - when: manual
      allow_failure: true

# 为特定客户构建 PDF
build-pdf-for-client:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - *set_script_permissions
    - mkdir -p build templates
    - *install_pdf_deps
  
  script:
    - make client=${CLIENT} format=pdf
  
  artifacts:
    name: "pdf-${CLIENT}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.pdf
    expire_in: 1 week
  
  rules:
    - when: manual
      allow_failure: true

# ==========================================
# 批量构建
# ==========================================

# 为特定客户构建（手动触发）
build-for-client:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - *set_script_permissions
    - mkdir -p build templates
  
  script:
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    - make client=${CLIENT} format=${FORMAT}
  
  artifacts:
    name: "document-${CLIENT}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
      - build/*.pdf
    expire_in: 1 week
  
  rules:
    - when: manual
      allow_failure: true

# 构建所有客户文档
build-all-clients:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - *set_script_permissions
    - mkdir -p build templates
    - *install_pdf_deps
  
  script:
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    - |
      for client_dir in clients/*/; do
        client=$(basename "$client_dir")
        echo "Building for client: $client"
        make client="$client" format=${FORMAT} || true
      done
  
  artifacts:
    name: "all-documents-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
      - build/*.pdf
    expire_in: 1 week
  
  rules:
    - when: manual
      allow_failure: true

# ==========================================
# Web 应用构建
# ==========================================

build-web:
  stage: build
  image: golang:1.21
  
  script:
    - cd web
    - go build -o doc-generator-web-linux-amd64 .
    - GOOS=windows GOARCH=amd64 go build -o doc-generator-web-windows-amd64.exe .
  
  artifacts:
    name: "web-app-${CI_COMMIT_SHORT_SHA}"
    paths:
      - web/doc-generator-web-linux-amd64
      - web/doc-generator-web-windows-amd64.exe
    expire_in: 1 week
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - web/**
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - web/**
    - when: manual
      allow_failure: true
