# ==========================================
# Markdown to Word Pipeline - GitLab CI/CD
# ==========================================

stages:
  - build

variables:
  # 默认客户配置，可通过 CI/CD 变量覆盖
  CLIENT: "default"

# 构建文档
build-document:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    # 设置脚本执行权限
    - chmod +x scripts/build.sh
    # 创建必要目录
    - mkdir -p build templates
  
  script:
    # 生成默认模板（如果不存在）
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    # 执行构建
    - make client=${CLIENT}
  
  artifacts:
    name: "document-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
    expire_in: 1 week
  
  rules:
    # 主分支推送时自动构建
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
    # 手动触发
    - when: manual
      allow_failure: true

# 为特定客户构建（手动触发）
build-for-client:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - chmod +x scripts/build.sh
    - mkdir -p build templates
  
  script:
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    - make client=${CLIENT}
  
  artifacts:
    name: "document-${CLIENT}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
    expire_in: 1 week
  
  rules:
    # 仅手动触发
    - when: manual
      allow_failure: true

# 构建所有客户文档
build-all-clients:
  stage: build
  image: pandoc/latex:latest
  
  before_script:
    - chmod +x scripts/build.sh
    - mkdir -p build templates
  
  script:
    - |
      if [ ! -f "templates/default.docx" ]; then
        echo "# Template" | pandoc -o templates/default.docx
      fi
    # 遍历所有客户配置并构建
    - |
      for client_dir in clients/*/; do
        client=$(basename "$client_dir")
        echo "Building for client: $client"
        make client="$client" || true
      done
  
  artifacts:
    name: "all-documents-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/*.docx
    expire_in: 1 week
  
  rules:
    # 仅手动触发
    - when: manual
      allow_failure: true

# ==========================================
# Web 应用构建
# ==========================================

# 构建 Web 应用
build-web:
  stage: build
  image: golang:1.21
  
  script:
    - cd web
    - go build -o doc-generator-web-linux-amd64 .
    - GOOS=windows GOARCH=amd64 go build -o doc-generator-web-windows-amd64.exe .
  
  artifacts:
    name: "web-app-${CI_COMMIT_SHORT_SHA}"
    paths:
      - web/doc-generator-web-linux-amd64
      - web/doc-generator-web-windows-amd64.exe
    expire_in: 1 week
  
  rules:
    # web 目录有变更时自动构建
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - web/**
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - web/**
    # 手动触发
    - when: manual
      allow_failure: true

# 构建 Docker 镜像（可选）
build-web-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  
  script:
    - docker build -t doc-generator-web:${CI_COMMIT_SHORT_SHA} -f web/Dockerfile .
    - docker tag doc-generator-web:${CI_COMMIT_SHORT_SHA} doc-generator-web:latest
    # 如果配置了 Container Registry，可以推送镜像
    # - docker push $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA}
    # - docker push $CI_REGISTRY_IMAGE:latest
  
  rules:
    # 仅手动触发
    - when: manual
      allow_failure: true
