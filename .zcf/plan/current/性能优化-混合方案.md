# 性能优化 - 混合方案执行计划

**任务描述**: 优化 Markdown-to-Word-Pipeline 项目的页面加载性能，特别是主页和编辑器页面

**创建时间**: 2026-02-12 00:33:42

**方案类型**: 混合方案（渐进式优化 + 编辑器调研）

---

## 📊 当前性能问题

### 主页 (index.html)
- **问题**: 加载了 Vditor (~500KB)，但实际不使用
- **影响**: 首屏加载时间过长
- **资源列表**:
  - style.css
  - Vditor CSS + JS (不必要)
  - app.js, editor.js, git.js, resource.js

### 编辑器页面 (editor.html)
- **问题**: 
  1. Vditor 完整包 ~500KB 同步加载
  2. 20+ 个编辑器模块 JS 文件独立加载
  3. 无资源压缩、合并或懒加载
- **影响**: 知识库加载特别慢

---

## 🎯 优化目标

| 页面 | 当前状态 | 目标 | 预期提升 |
|------|---------|------|---------|
| 主页 | 加载慢 | 快速响应 | 减少 60% |
| 编辑器 | 知识库加载久 | 流畅加载 | 减少 40% |

---

## 📋 执行步骤

### 阶段 1：主页性能优化（高优先级）

#### 1.1 移除不必要的 Vditor 加载
**文件**: `web/static/index.html`

**操作**:
```html
<!-- 删除以下行 -->
<link rel="stylesheet" href="/static/vendor/vditor/dist/index.css" />
<script src="/static/vendor/vditor/dist/index.min.js"></script>
```

**预期结果**: 主页减少 ~500KB 资源加载

#### 1.2 检查并清理 app.js 中的 Vditor 引用
**文件**: `web/static/app.js`

**操作**:
- 搜索 `Vditor` 相关代码
- 如果主页不使用编辑器，移除相关代码
- 保留编辑器模态框的代码（如果需要）

#### 1.3 测试主页功能
**验证项**:
- [ ] 客户配置选择正常
- [ ] 文档类型列表正常
- [ ] 文档生成功能正常
- [ ] 下载功能正常
- [ ] 配置管理功能正常

---

### 阶段 2：编辑器页面优化（高优先级）

#### 2.1 实现 Vditor 懒加载
**文件**: `web/static/editor.html`, `web/static/editor/vditor.js`

**方案**:
```javascript
// 动态加载 Vditor
function loadVditor() {
  return new Promise((resolve, reject) => {
    if (window.Vditor) {
      resolve();
      return;
    }
    
    // 加载 CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = '/static/vendor/vditor/dist/index.css';
    document.head.appendChild(link);
    
    // 加载 JS
    const script = document.createElement('script');
    script.src = '/static/vendor/vditor/dist/index.min.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// 仅在需要时加载
async function initEditor() {
  showLoading();
  await loadVditor();
  // 初始化编辑器...
  hideLoading();
}
```

**预期结果**: 编辑器页面首屏不加载 Vditor，仅在打开文件时加载

#### 2.2 合并编辑器 JS 模块
**文件**: 创建 `web/static/editor/bundle.js`

**方案**:
```bash
# 手动合并（按依赖顺序）
cat editor/utils.js \
    editor/state.js \
    editor/loading.js \
    editor/recent.js \
    editor/theme.js \
    editor/layout.js \
    editor/tree.js \
    editor/virtual-tree.js \
    editor/tabs.js \
    editor/vditor.js \
    editor/editor-cache.js \
    editor/git.js \
    editor/files.js \
    editor/attachments.js \
    editor/quickopen.js \
    editor/commands.js \
    editor/autosave.js \
    editor/breadcrumb.js \
    editor/history.js \
    editor/main.js > editor/bundle.js
```

**修改 editor.html**:
```html
<!-- 替换 20+ 个 script 标签为 -->
<script src="/static/editor/bundle.js?v=1" defer></script>
```

**预期结果**: 减少 19 个 HTTP 请求

#### 2.3 添加资源预加载
**文件**: `web/static/editor.html`

**操作**:
```html
<head>
  <!-- 预加载关键资源 -->
  <link rel="preload" href="/static/style.css?v=12" as="style">
  <link rel="preload" href="/static/editor.css?v=4" as="style">
  <link rel="preload" href="/static/editor/bundle.js?v=1" as="script">
  
  <!-- 预连接 CDN（如果使用） -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
</head>
```

---

### 阶段 3：CDN 和缓存优化（中优先级）

#### 3.1 配置 Vditor CDN（带本地 fallback）
**文件**: `web/static/editor/vditor.js`

**方案**:
```javascript
function loadVditor() {
  return new Promise((resolve, reject) => {
    if (window.Vditor) {
      resolve();
      return;
    }
    
    // 尝试 CDN
    const cdnScript = document.createElement('script');
    cdnScript.src = 'https://cdn.jsdelivr.net/npm/vditor@3.11.2/dist/index.min.js';
    cdnScript.onload = () => {
      console.log('Vditor loaded from CDN');
      resolve();
    };
    cdnScript.onerror = () => {
      console.warn('CDN failed, loading from local');
      // Fallback 到本地
      const localScript = document.createElement('script');
      localScript.src = '/static/vendor/vditor/dist/index.min.js';
      localScript.onload = resolve;
      localScript.onerror = reject;
      document.head.appendChild(localScript);
    };
    document.head.appendChild(cdnScript);
  });
}
```

#### 3.2 配置 Viewer.js CDN
**文件**: `web/static/editor.html`

**方案**: 同 Vditor，使用 CDN + fallback 模式

#### 3.3 优化静态资源缓存策略
**文件**: `web/main.go`

**方案**:
```go
// 添加缓存头
func cacheMiddleware(next http.Handler) http.Handler {
  return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    // 静态资源缓存 1 年
    if strings.HasPrefix(r.URL.Path, "/static/") {
      w.Header().Set("Cache-Control", "public, max-age=31536000, immutable")
    }
    next.ServeHTTP(w, r)
  })
}
```

---

### 阶段 4：Go 后端优化（中优先级）

#### 4.1 添加 Gzip 压缩中间件
**文件**: `web/main.go`

**方案**:
```go
import (
  "compress/gzip"
  "io"
  "strings"
)

type gzipResponseWriter struct {
  io.Writer
  http.ResponseWriter
}

func (w gzipResponseWriter) Write(b []byte) (int, error) {
  return w.Writer.Write(b)
}

func gzipMiddleware(next http.Handler) http.Handler {
  return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    if !strings.Contains(r.Header.Get("Accept-Encoding"), "gzip") {
      next.ServeHTTP(w, r)
      return
    }
    
    w.Header().Set("Content-Encoding", "gzip")
    gz := gzip.NewWriter(w)
    defer gz.Close()
    
    gzw := gzipResponseWriter{Writer: gz, ResponseWriter: w}
    next.ServeHTTP(gzw, r)
  })
}

// 在 main() 中应用
mux := http.NewServeMux()
// ... 注册路由
handler := gzipMiddleware(mux)
http.ListenAndServe(addr, handler)
```

**预期结果**: 文本资源（HTML/CSS/JS）减少 70% 体积

---

### 阶段 5：轻量级编辑器调研报告（低优先级）

#### 5.1 编辑器对比表

| 编辑器 | 体积 | 依赖 | 功能 | 迁移难度 | 推荐度 |
|--------|------|------|------|---------|--------|
| **Vditor** (当前) | ~500KB | 零 | 完整 | - | ⭐⭐⭐ |
| **EasyMDE** | ~50KB | 零 | 基础 | 中 | ⭐⭐⭐⭐⭐ |
| **SimpleMDE** | ~40KB | 零 | 基础 | 中 | ⭐⭐⭐⭐ |
| **Toast UI Editor** | ~150KB | 零 | 丰富 | 高 | ⭐⭐⭐⭐ |
| **TinyMDE** | ~20KB | 零 | 极简 | 低 | ⭐⭐⭐ |
| **quikdown** | 9KB | 零 | 极简 | 低 | ⭐⭐⭐ |

**推荐**: **EasyMDE**
- 体积仅 Vditor 的 1/10
- 功能满足基本需求（编辑、预览、工具栏）
- 零依赖，易于集成
- 社区活跃，文档完善

#### 5.2 迁移指南（EasyMDE）

**步骤**:
1. 安装 EasyMDE: `npm install easymde`
2. 替换初始化代码:
```javascript
// 旧代码（Vditor）
const vditor = new Vditor('editor', {
  mode: 'ir',
  toolbar: [...],
  upload: {...}
});

// 新代码（EasyMDE）
const easymde = new EasyMDE({
  element: document.getElementById('editor'),
  toolbar: [...],
  uploadImage: true,
  imageUploadFunction: (file, onSuccess, onError) => {
    // 上传逻辑
  }
});
```

3. 迁移功能映射:
   - `vditor.getValue()` → `easymde.value()`
   - `vditor.setValue()` → `easymde.value(newValue)`
   - `vditor.focus()` → `easymde.codemirror.focus()`

**预计工作量**: 1-2 天

---

### 阶段 6：性能测试和验证（高优先级）

#### 6.1 主页加载时间测试
**工具**: Chrome DevTools Network 面板

**测试步骤**:
1. 清除缓存
2. 打开 Network 面板
3. 访问主页
4. 记录 DOMContentLoaded 和 Load 时间

**目标**:
- 优化前: ~2-3 秒
- 优化后: <1 秒（减少 60%）

#### 6.2 编辑器页面加载时间测试
**测试步骤**:
1. 清除缓存
2. 访问编辑器页面
3. 记录首屏渲染时间
4. 打开一个文件，记录编辑器初始化时间

**目标**:
- 首屏: 优化前 ~3-4 秒 → 优化后 <2 秒
- 编辑器初始化: 优化前 ~2 秒 → 优化后 <1 秒

#### 6.3 功能回归测试
**测试清单**:
- [ ] 主页：客户选择、文档生成、下载
- [ ] 编辑器：文件树、编辑、保存、预览
- [ ] Git：状态、提交、推送
- [ ] 配置：新建、编辑、删除
- [ ] 资源管理：字体、模板上传

---

## 📊 预期效果总结

| 优化项 | 预期提升 | 实施难度 | 优先级 |
|--------|---------|---------|--------|
| 主页移除 Vditor | 减少 60% 加载时间 | 低 | 高 |
| 编辑器懒加载 | 减少 40% 首屏时间 | 中 | 高 |
| JS 模块合并 | 减少 19 个请求 | 低 | 高 |
| CDN + fallback | 提升 30% 加载速度 | 中 | 中 |
| Gzip 压缩 | 减少 70% 传输体积 | 低 | 中 |

**总体预期**:
- 主页加载时间: **减少 60%**
- 编辑器加载时间: **减少 40%**
- 实施时间: **2-3 小时**

---

## 🔄 后续优化建议

如果完成上述优化后仍需进一步提升，可以考虑：

1. **替换为轻量级编辑器**（EasyMDE）
   - 预期提升: 额外减少 30% 编辑器加载时间
   - 工作量: 1-2 天

2. **引入构建工具**（Vite/esbuild）
   - 预期提升: 额外减少 20% 整体加载时间
   - 工作量: 3-5 天

3. **HTTP/2 推送**
   - 预期提升: 减少 10-15% 首屏时间
   - 工作量: 1 天

---

## ✅ 完成标准

- [ ] 所有 TODO 项标记为 completed
- [ ] 主页加载时间减少 ≥50%
- [ ] 编辑器加载时间减少 ≥35%
- [ ] 所有功能正常工作
- [ ] 无 console 错误
- [ ] 编辑器调研报告完成

---

**计划创建时间**: 2026-02-12 00:33:42  
**预计完成时间**: 2026-02-12 03:00:00（约 2.5 小时）
